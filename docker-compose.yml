version: "2.1"

volumes:
  downloads: {}
  duplicati: {}
  jellyfin: {}
  letsencrypt: {}
  netdatalib: {}
  netdatacache: {}
  nzbhydra: {}
  ombi: {}
  overseerr: {}
  plex: {}
  prowlarr: {}
  proxy: {}
  radarr: {}
  sabnzbd: {}
  sonarr: {}
  syncthing: {}
  tailscale: {}
  tautulli: {}

services:
  # https://docs.linuxserver.io/images/docker-plex
  plex:
    image: linuxserver/plex:1.32.6@sha256:5405786ccc12107d9277ff0cf2a939fe03e4c41b65f50ea2c5f1a163b50bcdf4
    restart: unless-stopped
    devices:
      - /dev/dri:/dev/dri
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - plex:/config
      - downloads:/downloads

  # https://docs.linuxserver.io/images/docker-jellyfin
  jellyfin:
    image: linuxserver/jellyfin:10.8.11@sha256:0399a4cc830672a472ba899beac5896d510b899ce223f53129720f87fd4642d4
    restart: unless-stopped
    devices:
      - /dev/dri:/dev/dri
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - jellyfin:/config
      - downloads:/downloads

  # https://docs.linuxserver.io/images/docker-sonarr
  sonarr:
    image: linuxserver/sonarr:3.0.10@sha256:b97eb98d7237783f12936588cb71e755ae94df0184b0c89da2634f8544e338f0
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - sonarr:/config
      - downloads:/downloads

  # https://docs.linuxserver.io/images/docker-radarr
  radarr:
    image: linuxserver/radarr:5.0.3@sha256:e660626b6f7e08298573dba7e89b0d40d1b11dceb9010a28074385567ad36fe7
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - radarr:/config
      - downloads:/downloads

  # https://docs.linuxserver.io/images/docker-prowlarr
  prowlarr:
    image: linuxserver/prowlarr:1.10.0-develop@sha256:fca2a3b617a86033bed3a72bd80c5905deb7c47a4ce57f0b7fccaca63114fc45
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - prowlarr:/config
      - downloads:/downloads

  # https://docs.linuxserver.io/images/docker-nzbhydra
  nzbhydra:
    image: linuxserver/nzbhydra2:5.1.11@sha256:b13a9f6483dc39d145500df0df9a7455feeac7354e4a904b2f9867f94ce1d676
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - nzbhydra:/config
      - downloads:/downloads

  # https://docs.linuxserver.io/images/docker-ombi
  ombi:
    image: linuxserver/ombi:4.43.5@sha256:7c238781d9430b7b922391f884c869f1788b67bac0bc98956455baf6b17016a9
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - ombi:/config

  # https://docs.linuxserver.io/images/docker-overseerr
  overseerr:
    image: lscr.io/linuxserver/overseerr:1.33.2@sha256:afa85c37a725844a073e16ba870c6124943a9e8b05ed6791a1803e29c21f45a3
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - overseerr:/config

  # https://docs.linuxserver.io/images/docker-sabnzbd
  sabnzbd:
    image: linuxserver/sabnzbd:4.1.0@sha256:e5240377d64e31de0b3fecdf640f8bdf4a5d4591debd1f0fb6bde43ff3fb6262
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - sabnzbd:/config
      - downloads:/downloads

  # https://docs.linuxserver.io/images/docker-tautulli
  tautulli:
    image: linuxserver/tautulli:2.13.1@sha256:58a7a9391c0a1fba611608f9df2fabeb14d834edf5427dc475d53b506ef2c351
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - tautulli:/config

    # https://hub.docker.com/r/netdata/netdata
  netdata:
    image: netdata/netdata:v1.43.0@sha256:a3b217677de7a742fb2e65445cf76c9af0ef04d6fbb37d3b28105feddbd209af
    privileged: true
    cap_add:
      - SYS_PTRACE
    environment:
      DOCKER_HOST: "/var/run/balena.sock"
      PGID: "990" # ls -nd /var/run/balena.sock | awk '{print $4}'
    labels:
      io.balena.features.balena-socket: 1
      io.balena.features.procfs: 1
      io.balena.features.sysfs: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    security_opt:
      - apparmor:unconfined
    tmpfs:
      - /tmp
    volumes:
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata

  # https://docs.linuxserver.io/images/docker-duplicati
  duplicati:
    image: lscr.io/linuxserver/duplicati:v2.0.6.3-2.0.6.3_beta_2021-06-17-ls160@sha256:9cf7c7a14bf1474d44aa29d329552bf32af58090f4cfa5e61e35a88b2cd4677e
    restart: unless-stopped
    environment:
      PUID: "0"
      PGID: "0"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - duplicati:/config
      # any volumes that might be worth backing up
      - syncthing:/volumes/syncthing
      - plex:/volumes/plex
      - sonarr:/volumes/sonarr
      - radarr:/volumes/radarr
      - nzbhydra:/volumes/nzbhydra
      - jellyfin:/volumes/jellyfin
      - prowlarr:/volumes/prowlarr
      - ombi:/volumes/ombi
      - overseerr:/volumes/overseerr
      - sabnzbd:/volumes/sabnzbd
      - tailscale:/volumes/tailscale
      - downloads:/volumes/downloads
      - proxy:/volumes/proxy
      - tautulli:/volumes/tautulli

  # https://docs.linuxserver.io/images/docker-syncthing
  syncthing:
    image: lscr.io/linuxserver/syncthing:1.25.0@sha256:37610128d1fe84a78e541db19123dafe1be3c2d081cc78d4afa14ab151d7d5ac
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      DOCKER_MODS: "ghcr.io/klutchell/balena-mediaserver:latest"
    labels:
      io.balena.features.supervisor-api: 1
    network_mode: service:proxy
    depends_on:
      - proxy
      - tailscale
    tmpfs:
      - /tmp
    volumes:
      - syncthing:/config
      # any volumes that might be worth syncronizing between machines
      - plex:/volumes/plex
      - sonarr:/volumes/sonarr
      - radarr:/volumes/radarr
      - nzbhydra:/volumes/nzbhydra
      - jellyfin:/volumes/jellyfin
      - prowlarr:/volumes/prowlarr
      - ombi:/volumes/ombi
      - overseerr:/volumes/overseerr
      - sabnzbd:/volumes/sabnzbd
      - tailscale:/volumes/tailscale
      - downloads:/volumes/downloads
      - proxy:/volumes/proxy
      - tautulli:/volumes/tautulli

  # https://hub.docker.com/r/tailscale/tailscale
  tailscale:
    image: tailscale/tailscale:v1.50.1@sha256:9540c3289987a41db3342dabe334cbcf0f58ecdc49a083a1876e219fbf151a4d
    network_mode: service:proxy
    depends_on:
      - proxy
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    labels:
      io.balena.features.kernel-modules: 1
    healthcheck:
      test: ["CMD-SHELL", "tailscale status"]
      interval: 1s
      timeout: 5s
      retries: 60
    tmpfs:
      - /tmp
      - /var/run/
    volumes:
      - tailscale:/var/lib/tailscale
    environment:
      TS_STATE_DIR: "/var/lib/tailscale"
      TS_SOCKET: "/var/run/tailscale/tailscaled.sock"
      TS_EXTRA_ARGS: "--reset --accept-routes"
      TS_AUTH_ONCE: "true"
      # TS_USERSPACE: "true"
      TS_HOSTNAME: mediaserver
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        # load the kernel module if it exists
        if modprobe wireguard 2>/dev/null
        then
          modinfo wireguard || true
          export TS_USERSPACE="${TS_USERSPACE:-false}"
        fi

        mkdir -p /dev/net
        [ ! -c /dev/net/tun ] && mknod /dev/net/tun c 10 200
        
        exec /usr/local/bin/containerboot

# https://hub.docker.com/r/jc21/nginx-proxy-manager
  proxy:
    image: jc21/nginx-proxy-manager:2.10.4@sha256:e1000dd653d193ac70cb3635c27333b0183a11f987e2b1c6043589d9d948bc0f
    ports:
      # nginx
      - 80:80/tcp
      - 443:443/tcp
      - 127.0.0.0:81:81/tcp
      # plex
      - 32400:32400/tcp
      # jellyfin
      - 8096:8096/tcp
      - 7359:7359/udp
      # syncthing
      - 22000:22000/tcp
      - 22000:22000/udp
      - 21027:21027/udp
      # all other service ports can be accessed via tailnet or reverse proxy
    tmpfs:
      - /tmp
    volumes:
      - proxy:/data
      - letsencrypt:/etc/letsencrypt
